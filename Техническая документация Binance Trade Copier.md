# Техническая документация Binance Trade Copier

## Обзор архитектуры

Binance Trade Copier представляет собой многокомпонентную систему для автоматического копирования торговых сделок между аккаунтами Binance Futures. Система построена на основе модульной архитектуры с четким разделением ответственности между компонентами.

### Основные принципы проектирования

Система спроектирована с учетом следующих принципов:

**Модульность и разделение ответственности.** Каждый компонент системы отвечает за конкретную функциональность: мониторинг сделок, копирование ордеров, хранение данных и предоставление пользовательского интерфейса. Такой подход обеспечивает легкость сопровождения и возможность независимого развития каждого модуля.

**Отказоустойчивость и обработка ошибок.** Система включает комплексную обработку ошибок на всех уровнях, от сетевых запросов до операций с базой данных. Реализованы механизмы повторных попыток, логирования ошибок и graceful degradation при недоступности отдельных сервисов.

**Безопасность и изоляция.** API ключи хранятся в переменных окружения и никогда не попадают в логи или пользовательский интерфейс. Система использует минимально необходимые права доступа для каждого типа операций.

**Масштабируемость и производительность.** Архитектура позволяет легко добавлять новые торговые пары, аккаунты и функциональность без существенных изменений в базовом коде.

## Компоненты системы

### BinanceFuturesClient

Базовый класс для взаимодействия с Binance Futures API. Обеспечивает низкоуровневые операции подключения, аутентификации и выполнения запросов.

**Основные методы:**
- `_generate_signature()` - генерация HMAC-SHA256 подписи для аутентифицированных запросов
- `_make_request()` - универсальный метод для выполнения HTTP запросов с обработкой ошибок
- `get_server_time()` - получение времени сервера для синхронизации
- `get_account_info()` - получение информации об аккаунте
- `get_all_orders()` - получение всех ордеров по символу
- `get_user_trades()` - получение сделок пользователя
- `create_order()` - создание нового ордера

**Обработка ошибок:** Класс включает комплексную обработку различных типов ошибок, включая сетевые проблемы, ошибки API и проблемы с аутентификацией. Все ошибки логируются с соответствующим уровнем детализации.

### BinanceTradeMonitor

Компонент для мониторинга реального аккаунта и обнаружения новых сделок. Реализует логику фильтрации сделок по времени, чтобы копировать только те сделки, которые были открыты после запуска системы.

**Ключевые особенности:**
- Установка точки отсчета времени при первом запуске
- Периодический опрос API для получения новых сделок
- Фильтрация уже обработанных сделок через базу данных
- Поддержка множественных торговых пар

**Алгоритм работы:**
1. При первом запуске система сохраняет текущий timestamp как точку отсчета
2. Периодически выполняется запрос к API для получения сделок после точки отсчета
3. Новые сделки сравниваются с базой данных обработанных сделок
4. Только действительно новые сделки передаются для копирования

### BinanceTradeCopier

Компонент для копирования сделок в тестовый аккаунт. Преобразует информацию о сделках в соответствующие рыночные ордера и выполняет их в целевом аккаунте.

**Логика копирования:**
- Анализ параметров исходной сделки (символ, сторона, количество)
- Создание рыночного ордера с соответствующими параметрами
- Обработка результата и обновление статуса в базе данных
- Логирование всех операций для аудита

**Обработка особых случаев:**
- Проверка минимальных размеров ордеров для каждого символа
- Обработка недостаточного баланса
- Управление позициями (LONG/SHORT/BOTH)
- Retry логика для временных сбоев

### TradeDatabase

Компонент для локального хранения данных о сделках и настройках системы. Использует SQLite для обеспечения ACID-совместимости и простоты развертывания.

**Структура базы данных:**

Таблица `processed_trades`:
- `id` - уникальный идентификатор записи
- `trade_id` - идентификатор сделки из Binance API
- `symbol` - торговая пара
- `side` - сторона сделки (BUY/SELL)
- `quantity` - количество
- `price` - цена исполнения
- `timestamp` - время сделки
- `copied` - флаг успешного копирования
- `created_at` - время добавления записи

Таблица `settings`:
- `key` - ключ настройки
- `value` - значение настройки
- `updated_at` - время последнего обновления

**Методы работы с данными:**
- `save_trade()` - сохранение новой сделки
- `is_trade_processed()` - проверка обработки сделки
- `mark_trade_copied()` - отметка об успешном копировании
- `get_setting()` / `set_setting()` - управление настройками

### StreamlitApp

Веб-интерфейс для мониторинга и управления системой. Построен на фреймворке Streamlit и предоставляет интуитивно понятный интерфейс для всех операций.

**Основные разделы интерфейса:**

**Панель управления:**
- Запуск и остановка сервиса мониторинга
- Настройка параметров опроса
- Тестирование подключений к API
- Управление автообновлением интерфейса

**Дашборд метрик:**
- Количество найденных сделок
- Количество успешно скопированных сделок
- Счетчик ошибок
- Время последней проверки

**Вкладка "Обзор":**
- Список последних сделок с основной информацией
- Статистика по торговым парам
- Общие показатели производительности

**Вкладка "Сделки":**
- Полный список всех обработанных сделок
- Фильтрация по символу, стороне и статусу копирования
- Детальная информация о каждой сделке
- Экспорт данных в различных форматах

**Вкладка "Аналитика":**
- Графики объемов торгов по времени
- Распределение сделок по торговым парам
- Соотношение покупок и продаж
- Анализ производительности копирования

**Вкладка "Логи":**
- Просмотр системных логов в реальном времени
- Фильтрация по уровню логирования
- Поиск по содержимому логов
- Управление размером лог-файлов

## API интеграция

### Binance Futures API

Система использует официальный REST API Binance Futures для всех операций. Основные эндпоинты:

**Получение сделок пользователя:**
```
GET /fapi/v1/userTrades
```
Параметры:
- `symbol` - торговая пара (обязательный)
- `startTime` - начальное время в миллисекундах
- `endTime` - конечное время в миллисекундах
- `limit` - максимальное количество записей (до 1000)

**Создание нового ордера:**
```
POST /fapi/v1/order
```
Параметры:
- `symbol` - торговая пара
- `side` - сторона (BUY/SELL)
- `type` - тип ордера (MARKET, LIMIT, etc.)
- `quantity` - количество
- `positionSide` - сторона позиции (LONG/SHORT/BOTH)

**Получение информации об аккаунте:**
```
GET /fapi/v2/account
```
Возвращает баланс, открытые позиции и другую информацию об аккаунте.

### Аутентификация

Система использует API ключи и секретные ключи для аутентификации. Все аутентифицированные запросы подписываются с использованием HMAC-SHA256:

```python
def _generate_signature(self, params):
    query_string = '&'.join([f"{k}={v}" for k, v in params.items()])
    return hmac.new(
        self.secret_key.encode('utf-8'),
        query_string.encode('utf-8'),
        hashlib.sha256
    ).hexdigest()
```

### Обработка лимитов API

Binance API имеет ограничения на количество запросов в единицу времени. Система учитывает эти ограничения:

- Использование весов запросов для отслеживания лимитов
- Автоматические задержки между запросами
- Обработка ошибок превышения лимитов с повторными попытками
- Приоритизация критически важных запросов

## Конфигурация и развертывание

### Переменные окружения

Система использует файл `.env` для конфигурации:

```env
# API ключи реального аккаунта
REAL_API_KEY=your_real_api_key
REAL_SECRET_KEY=your_real_secret_key

# API ключи тестового аккаунта  
TEST_API_KEY=your_test_api_key
TEST_SECRET_KEY=your_test_secret_key

# Настройки подключения
REAL_BASE_URL=https://fapi.binance.com
TEST_BASE_URL=https://testnet.binancefuture.com

# Параметры мониторинга
POLLING_INTERVAL=10
MAX_RETRIES=3
TIMEOUT=30

# Настройки логирования
LOG_LEVEL=INFO
LOG_FILE=logs/trade_copier.log
```

### Docker конфигурация

Система поддерживает контейнеризацию с помощью Docker:

**Dockerfile особенности:**
- Базовый образ Python 3.11-slim для минимального размера
- Установка зависимостей из requirements.txt
- Создание необходимых директорий для данных и логов
- Настройка переменных окружения для Streamlit

**Docker Compose конфигурация:**
- Основной сервис для веб-интерфейса
- Дополнительный сервис для работы только в режиме мониторинга
- Монтирование томов для персистентности данных
- Настройка сети для изоляции

### Мониторинг и логирование

Система включает комплексную систему логирования:

**Уровни логирования:**
- `DEBUG` - детальная отладочная информация
- `INFO` - общая информация о работе системы
- `WARNING` - предупреждения о потенциальных проблемах
- `ERROR` - ошибки, требующие внимания

**Структура логов:**
```
2025-06-25 09:30:52,911 - TradeMonitor - INFO - Connection successful. Server time: 1750858253319
2025-06-25 09:30:53,857 - TradeMonitor - ERROR - Failed to get account info: (401, -2015, 'Invalid API-key')
```

**Ротация логов:**
Система поддерживает автоматическую ротацию лог-файлов для предотвращения неконтролируемого роста размера.

## Безопасность

### Управление API ключами

**Принципы безопасности:**
- API ключи никогда не хранятся в коде
- Использование переменных окружения для конфиденциальных данных
- Минимальные необходимые права для каждого типа ключей
- Регулярная ротация ключей

**Рекомендуемые права API ключей:**
- Реальный аккаунт: только чтение (Spot & Margin Trading, Futures)
- Тестовый аккаунт: чтение и торговля (Futures Trading)

### Сетевая безопасность

**Ограничения IP адресов:**
Рекомендуется настроить ограничения IP адресов в настройках API ключей Binance для дополнительной безопасности.

**HTTPS соединения:**
Все соединения с API Binance используют HTTPS с проверкой сертификатов.

### Аудит и мониторинг

**Логирование операций:**
Все операции с API логируются с указанием времени, типа операции и результата.

**Мониторинг аномалий:**
Система отслеживает необычную активность, такую как:
- Неожиданно большое количество сделок
- Ошибки аутентификации
- Превышение лимитов API

## Производительность и оптимизация

### Оптимизация запросов к API

**Батчинг запросов:**
Система группирует запросы для минимизации количества обращений к API.

**Кэширование:**
Информация о торговых парах и настройках аккаунта кэшируется для уменьшения нагрузки на API.

**Асинхронная обработка:**
Критически важные операции выполняются асинхронно для улучшения отзывчивости интерфейса.

### Управление ресурсами

**Память:**
Система использует эффективные структуры данных и освобождает память после обработки больших объемов данных.

**Дисковое пространство:**
Автоматическая очистка старых логов и данных для предотвращения переполнения диска.

**CPU:**
Оптимизированные алгоритмы обработки данных и минимизация вычислительно сложных операций.

## Расширяемость

### Добавление новых торговых пар

Система легко расширяется для поддержки новых торговых пар:

```python
# В конфигурации
MONITORED_SYMBOLS = ["BTCUSDT", "ETHUSDT", "ADAUSDT", "BNBUSDT"]

# В коде мониторинга
for symbol in MONITORED_SYMBOLS:
    trades = self.get_new_trades(symbol)
    # Обработка сделок
```

### Интеграция с другими биржами

Архитектура позволяет легко добавить поддержку других бирж через реализацию соответствующих интерфейсов:

```python
class ExchangeClient(ABC):
    @abstractmethod
    def get_trades(self, symbol: str) -> List[Trade]:
        pass
    
    @abstractmethod
    def create_order(self, order: Order) -> OrderResult:
        pass
```

### Дополнительные стратегии копирования

Система может быть расширена для поддержки различных стратегий копирования:
- Копирование с масштабированием объемов
- Фильтрация по размеру сделок
- Копирование только определенных торговых пар
- Задержки в копировании для анализа рынка

## Тестирование

### Модульные тесты

Каждый компонент системы покрыт модульными тестами:

```python
def test_trade_monitor_filtering():
    monitor = BinanceTradeMonitor()
    # Тестирование фильтрации сделок по времени
    
def test_trade_copier_order_creation():
    copier = BinanceTradeCopier()
    # Тестирование создания ордеров
```

### Интеграционные тесты

Тесты взаимодействия между компонентами и внешними API:

```python
def test_end_to_end_trade_copying():
    # Полный цикл от обнаружения сделки до копирования
```

### Тестирование в песочнице

Использование тестовой среды Binance для безопасного тестирования всех функций без риска для реальных средств.

## Мониторинг и алерты

### Метрики производительности

Система собирает следующие метрики:
- Количество обработанных сделок в единицу времени
- Время отклика API запросов
- Процент успешных копирований
- Использование ресурсов системы

### Система алертов

Настраиваемые алерты для критических событий:
- Ошибки подключения к API
- Превышение лимитов запросов
- Неудачные попытки копирования
- Аномальная торговая активность

### Дашборды мониторинга

Веб-интерфейс предоставляет реальное время мониторинга всех аспектов работы системы с возможностью настройки персональных дашбордов.

Данная техническая документация обеспечивает полное понимание архитектуры, принципов работы и возможностей расширения системы Binance Trade Copier. Система спроектирована с учетом лучших практик разработки финансовых приложений и обеспечивает надежную, безопасную и масштабируемую платформу для автоматического копирования торговых сделок.

